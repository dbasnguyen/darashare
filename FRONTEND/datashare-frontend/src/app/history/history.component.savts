/**
 * ================================
 * COMPONENT : HISTORY
 * ================================
 * R√¥le :
 * - Charger la liste des fichiers de l'utilisateur
 * - Afficher les infos (nom, taille, dates, statut)
 * - Supprimer un fichier
 * - Supprimer TOUS les fichiers
 * - Rafra√Æchir l'√©cran automatiquement
 *
 * Notes p√©dagogiques :
 * - Composant standalone ‚Üí imports dans @Component
 * - ChangeDetectorRef ‚Üí indispensable pour forcer Angular √† rafra√Æchir l'UI
 */

import { Component, ChangeDetectorRef } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { NgIf, NgFor, DatePipe, NgClass } from '@angular/common';
import { CommonModule } from '@angular/common';

@Component({
  selector: 'app-history',
  standalone: true,

  /**
   * Imports n√©cessaires pour le template HTML
   * - NgIf : *ngIf
   * - NgFor : *ngFor
   * - DatePipe : formatage des dates
   * - NgClass : classes dynamiques
   */
  imports: [CommonModule, NgIf, NgFor, DatePipe, NgClass],

  templateUrl: './history.component.html',
  styleUrls: ['./history.component.scss'],
})
export class HistoryComponent {

  /**
   * ================================
   * VARIABLES D'√âTAT DU COMPOSANT
   * ================================
   */
  files: any[] = [];       // Liste des fichiers
  loading = true;          // Affiche "Chargement..."
  errorMessage = '';       // Message d'erreur √©ventuel

  /**
   * Injection des services :
   * - HttpClient : communication avec le backend
   * - ChangeDetectorRef : force Angular √† rafra√Æchir l'√©cran
   */
  constructor(
    private http: HttpClient,
    private cdr: ChangeDetectorRef
  ) {}

  /**
   * ngOnInit()
   * Appel√© automatiquement √† l'arriv√©e sur la page
   */
  ngOnInit() {
    console.log(">>> HISTORY COMPONENT LOADED <<<");
    this.loadHistory();
  }

  /**
   * ================================
   * CHARGEMENT DE L'HISTORIQUE
   * ================================
   * - R√©cup√®re le token
   * - Appelle GET /files/my
   * - Met √† jour la liste
   * - Force Angular √† rafra√Æchir l'√©cran
   */
  loadHistory() {
    this.loading = true;

    const token = localStorage.getItem('token');

    this.http.get<any[]>('http://localhost:3000/files/my', {
      headers: { Authorization: `Bearer ${token}` }
    }).subscribe({
      next: (data) => {
        this.files = data;
        this.loading = false;
        this.cdr.detectChanges(); // üî• Mise √† jour UI
      },
      error: (err) => {
        console.error('Error loading history', err);
        this.errorMessage = 'Impossible de charger votre historique.';
        this.loading = false;
        this.cdr.detectChanges();
      },
    });
  }

  /**
   * ================================
   * SUPPRESSION D'UN FICHIER
   * ================================
   */
  deleteFile(file: any) {
    const confirmDelete = confirm(
      `Voulez-vous vraiment supprimer le fichier "${file.originalName}" ? Cette action est irreversible.`
    );
    if (!confirmDelete) return;

    const token = localStorage.getItem('token');

    this.http.delete(`http://localhost:3000/files/${file.id}`, {
      headers: { Authorization: `Bearer ${token}` }
    }).subscribe({
      next: () => {
        this.loadHistory(); // üî• Rafra√Æchit l'√©cran apr√®s suppression
      },
      error: (err) => {
        console.error('Error deleting file', err);
        alert('Erreur lors de la suppression du fichier.');
      },
    });
  }

  /**
   * ================================
   * SUPPRESSION DE TOUS LES FICHIERS
   * ================================
   */
  deleteAll() {
    const confirmDelete = confirm(
      "Voulez-vous vraiment supprimer TOUS vos fichiers ? Cette action est irr√©versible."
    );
    if (!confirmDelete) return;

    const token = localStorage.getItem('token');

    this.http.delete('http://localhost:3000/files/my', {
      headers: { Authorization: `Bearer ${token}` }
    }).subscribe({
      next: () => {
        this.loadHistory(); // üî• Rafra√Æchit l'√©cran apr√®s suppression globale
      },
      error: (err) => {
        console.error('Error deleting all files', err);
        alert('Erreur lors de la suppression de tous les fichiers.');
      }
    });
  }

  /**
   * ================================
   * UTILITAIRES POUR LE STATUT
   * ================================
   */
  getStatusLabel(file: any): string {
    return file.isExpired ? 'Expir√©' : 'Valide';
  }

  getStatusClass(file: any): string {
    return file.isExpired ? 'status-expired' : 'status-valid';
  }
}
